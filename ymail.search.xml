<?xml version="1.0" encoding="UTF-8"?>
<i:table xmlns:i="http://query.yahooapis.com/v1/schema/internalTable.xsd" xmlns="http://query.yahooapis.com/v1/schema/table.xsd" securityLevel="user">
  <meta>
    <author>Yahoo! Inc.</author>
    <sampleQuery>select * from {table}</sampleQuery>
  </meta>
  <i:bindings>
   <i:select itemPath="" produces="XML" auth="yahooOauth">
      <urls>
        <url>http://mail.yahooapis.com/ws/mail/v1.1/jsonrpc</url>
      </urls>
	  <inputs>
  	    <key id="query" type='xs:string' paramType='variable' />
	    <key id="from" type='xs:string' paramType='variable' />
   	    <key id="to" type='xs:string' paramType='variable' />
 	    <key id="subject" type='xs:string' paramType='variable'/>
	    <key id="cc" type='xs:string' paramType='variable' />
  	    <key id="bcc" type='xs:string' paramType='variable' />
	    <key id="flags" type='xs:string' paramType='variable' />
	    <key id="attachment" type='xs:string' paramType='variable' />
	    <key id="attachmentcount" type='xs:string' paramType='variable' />
	    <key id="attachmenttype" type='xs:string' paramType='variable' />
	    <key id="attachmentname" type='xs:string' paramType='variable' />
	    <key id="attachmentlanguages" type='xs:string' paramType='variable' />
	  <!--  <key id="searchtype" type='xs:string' paramType='variable' default='whole' /> -->
	    <key id="startMid" type='xs:string' paramType='variable' default='0' />
	    <key id="numMid" type='xs:string' paramType='variable' default='50' />
	    <key id="startInfo" type='xs:string' paramType='variable' default='0' />
	    <key id="numInfo" type='xs:string' paramType='variable' default='50' />
	    <key id="fid" type='xs:string' paramType='variable' />
	    <key id="mid" type='xs:string' paramType='variable' />
	    <key id="pid" type='xs:string' paramType='variable' />
	    <key id="search" type='xs:string' paramType='variable' />
	    <key id="sortKey" type='xs:string' paramType='variable' default='date' />
	    <key id="sortOrder" type='xs:string' paramType='variable' default='up' />
	   </inputs>
	   <execute><![CDATA[
		
		y.include("http://github.com/ramiyer/ymailtables/raw/master/messages.js");
		y.include("http://github.com/ramiyer/ymailtables/raw/master/json2.js");
		y.include("http://yui.yahooapis.com/3.1.1/build/yui/yui-min.js");

		var ymwsMethod = "SearchMessages";
	        //Intialization
	        var content = '';
	        var params = '[{}]';
//		var fid = escape(inputs["fid"]);

	        y.log("method = " + ymwsMethod);
	        y.log("request = " +request);

	        //Default ListMessage call with default params if no search clause mentioned 
			//Execute ListMessages Call with default params

	        //The moment we see the query having Subject,From, To,CC, BCC, Attachment.
	//		var searchParams = new Array();
		//	'"searchtype": ' +inputs['searchtype'] +  

		var builtSearchParams = buildSearchQuery(inputs);
	
		y.log("builtSearchParams values");
		
		y.log(builtSearchParams);
	//	var atttp = "attachmenttype:'pdf'";
//		var test = encodeURIComponent(atttp);		
//		var test = YAHOO.lang.JSON.stringify(builtSearchParams);		
	//	var test = YUI().JSON.stringify(builtSearchParams);		
	//	y.log(test);
	
		var jsonStr = JSON.stringify(builtSearchParams);
		
		//YUI().JSON.stringify(builtSearchParams);	
			
		y.log(jsonStr);

	        // get parameters for the given cascade method
			params = '[{' +
				 '     "search": {' +
						//		'"query":"' +builtSearchParams+ '"' +
					//			'"query":"' +escape(builtSearchParams)+ '"' +
								'"query":"' +jsonStr+ '"' +
							'}' +',' +
				 '"numInfo": "2000"' + ',' + 
				 '"numMid": "2000"' + ',' +
				 '"sortKey": "date"' + ',' +
				 '"sortOrder": "up"' +
			 '}]';

			
	        content = '{' +
	            '"method" : "' + ymwsMethod + '",' +
	            '"params" : ' + params +
	        '}';

			y.log(content);	
			var returned_response = request.post(content).response;
			response.object = returned_response;
		
		 ]]></execute>
  	 </i:select>
   </i:bindings>
</i:table>		
